# 指令协议
- [指令协议](#指令协议)
  - [前言](#前言)
    - [状态字符串定义](#状态字符串定义)
    - [数据类型定义](#数据类型定义)
      - [**整数定义**](#整数定义)
      - [**字符串定义**](#字符串定义)
      - [**布尔值定义**](#布尔值定义)
  - [手动调节气囊 (1)](#手动调节气囊-1)
    - [请求 (长度3 + 13 = 16)](#请求-长度3--13--16)
    - [响应(长度: 4 = 3 + 1)](#响应长度-4--3--1)
  - [匹配床垫 (2)](#匹配床垫-2)
    - [请求(长度: 3 = 3 + 0)](#请求长度-3--3--0)
    - [响应(长度: 4 = 3 + 1)](#响应长度-4--3--1-1)
  - [同步床垫系统时间(3)](#同步床垫系统时间3)
    - [请求(长度: 3)](#请求长度-3)
    - [响应(长度: 4 = 3 + 1)](#响应长度-4--3--1-2)
  - [获取气囊手动调节设置的气压(4)](#获取气囊手动调节设置的气压4)
    - [请求(长度: 3)](#请求长度-3-1)
    - [响应(长度: 11 = 3 + 8)](#响应长度-11--3--8)
  - [修改气囊调节模式(5)](#修改气囊调节模式5)
    - [请求(长度: 3 + 1 = 4)](#请求长度-3--1--4)
    - [响应(长度: 4 = 3 + 1)](#响应长度-4--3--1-3)
  - [心跳包(6)](#心跳包6)
    - [请求(长度: 3)](#请求长度-3-2)
    - [响应(长度: 4 = 3 + 1)](#响应长度-4--3--1-4)
  - [获取床垫固件版本(7)](#获取床垫固件版本7)
    - [请求(长度: 3)](#请求长度-3-3)
    - [响应(长度: 4 = 3 + 1)](#响应长度-4--3--1-5)
  - [气囊补气(8)](#气囊补气8)
    - [请求(长度: 3 + 4 = 7)](#请求长度-3--4--7)
    - [响应(长度: 4 = 3 + 1)](#响应长度-4--3--1-6)
  - [获取下一步升级信息(9)](#获取下一步升级信息9)
    - [请求(长度: 3)](#请求长度-3-4)
    - [响应(长度: 3 + 10 + n)](#响应长度-3--10--n)
  - [关闭温控(10)](#关闭温控10)
    - [请求(长度: 3)](#请求长度-3-5)
    - [响应(长度: 4 = 3 + 1)](#响应长度-4--3--1-7)
  - [切换温控模式(b)](#切换温控模式b)
    - [请求(长度: 7)](#请求长度-7)
    - [响应(长度: 4 = 3 + 1)](#响应长度-4--3--1-8)
  - [获取体感闹钟列表(c)](#获取体感闹钟列表c)
    - [请求(长度: 3)](#请求长度-3-6)
    - [响应(长度: 3 + 1 + n \* 3)](#响应长度-3--1--n--3)
  - [添加体感闹钟(d)](#添加体感闹钟d)
    - [请求(长度: 7)](#请求长度-7-1)
    - [响应(长度: 4 = 3 + 1)](#响应长度-4--3--1-9)
  - [删除体感闹钟(e)](#删除体感闹钟e)
    - [请求(长度: 3 + 1 + n \* 2)](#请求长度-3--1--n--2)
    - [响应(长度: 4 = 3 + 1)](#响应长度-4--3--1-10)
  - [修改体感闹钟(f)](#修改体感闹钟f)
    - [请求(长度: 7)](#请求长度-7-2)
    - [响应(长度: 4 = 3 + 1)](#响应长度-4--3--1-11)
  - [获取睡眠报告数据(g)](#获取睡眠报告数据g)
    - [请求(长度: 3)](#请求长度-3-7)
    - [响应(长度: 3 + 1 + n \* 2)](#响应长度-3--1--n--2)
  - [光子开关(h)](#光子开关h)
    - [响应(长度: 3 + 1 = 4)](#响应长度-3--1--4)

## 前言

- 之前所有的指令都是通过 `json` 进行自描述的, 因此开发起来会更加简单
- 但是考虑到后续通过蓝牙的数据更加的多且更加频繁，`json` 本身携带的用来描述的数据相对来说，非常多。所以需要尽可能的减少单次指令`传输的数据量`
- 因此, 现在部分频繁使用的指令，通过约定的方式的方式来传输二进制数据, 而不再使用 `json` 这种字符串数据
- 尽可能的将一个指令封装在一个 ble 包(`20Bytes`)中, 以减少包的数量

### 状态字符串定义

| 编号 | 状态字符串              | 说明                     |
| ---- | ----------------------- | ------------------------ |
| 0    | `待机中...`             | 什么任务都没有的默认状态 |
| 1    | `正在调节气囊软硬度...` | 手动调节中               |
| 2    | `左侧正在瑜伽模式...`   | 瑜伽模式                 |
| 3    | `右侧正在瑜伽模式...`   | 瑜伽模式                 |
| 4    | `智能适应中...`         | 智能适应                 |


### 数据类型定义

#### **整数定义**

- 所有的整数都是 `大端` 的方式进行传输
- 整数字节长度由字段本身进行约定

#### **字符串定义**

- 所有的字符串都是 `utf-8` 编码
- 传输的第一个字节为字符串的长度, 因此字符串的长度最大为 `255` 个字节

#### **布尔值定义**

- 布尔值使用 `1` 个字节进行传输
- `0` 表示 `false`, `1` 表示 `true`

## 手动调节气囊 (1)

### 请求 (长度3 + 13 = 16)

**path(长度: 3)**

`1\n\n`

**data(长度: 13)**

| 字段      | 长度 | 类型 | 描述         |
| --------- | ---- | ---- | ------------ |
| `user_id` | 4    | int  | 用户ID       |
| `la1`     | 1    | int  | 左1气囊      |
| `la2`     | 1    | int  | 左2气囊      |
| `la3`     | 1    | int  | 左3气囊      |
| `la4`     | 1    | int  | 左4气囊      |
| `ra1`     | 1    | int  | 右1气囊      |
| `ra2`     | 1    | int  | 右2气囊      |
| `ra3`     | 1    | int  | 右3气囊      |
| `ra4`     | 1    | int  | 右4气囊      |
| `mask`    | 1    | int  | 气囊调整掩码 |

### 响应(长度: 4 = 3 + 1)

**path(长度: 3)**

`2\n\n`

**data(长度: 1)**

| 字段     | 长度 | 类型 | 描述 |
| -------- | ---- | ---- | ---- |
| `status` | 1    | int  | 空   |

## 匹配床垫 (2)

### 请求(长度: 3 = 3 + 0)

**path(长度: 3)**

`2\n\n`

**data(长度: 0)**

| 字段 | 长度 | 类型 | 描述 |
| ---- | ---- | ---- | ---- |
| `-`  | 0    | void | 空   |

### 响应(长度: 4 = 3 + 1)

**path (长度: 3)**

`2\n\n`

**data (长度: 1)**

| 字段   | 长度 | 类型 | 描述                       |
| ------ | ---- | ---- | -------------------------- |
| `状态` | 1    | int  | 是否匹配成功 1:成功 2:失败 |

## 同步床垫系统时间(3)

### 请求(长度: 3)

**path(长度: 3)**

`3\n\n`

**data (长度: 4)**

| 字段   | 长度 | 类型 | 描述   |
| ------ | ---- | ---- | ------ |
| `time` | 4    | int  | 时间戳 |


### 响应(长度: 4 = 3 + 1)

**path(长度: 3)**

`3\n\n`

**data (长度: 1)**
| 字段       | 长度 | 类型 | 描述                  |
| ---------- | ---- | ---- | --------------------- |
| `床垫类型` | 1    | int  | 1:智尊 2:智享 3：智美 |


## 获取气囊手动调节设置的气压(4)

### 请求(长度: 3)

**path(长度: 3)**

`4\n\n`

**data (长度: 0)**
| 字段 | 长度 | 类型 | 描述 |
| ---- | ---- | ---- | ---- |
| `-`  | 0    | void | 空   |

### 响应(长度: 11 = 3 + 8)

**path(长度: 3)**

`4\n\n`

**data (长度: 8)**

存在手动设置时, 才会返回气压数据

| 字段  | 长度 | 类型 | 描述    |
| ----- | ---- | ---- | ------- |
| `la1` | 1    | int  | 左1气囊 |
| `la2` | 1    | int  | 左2气囊 |
| `la3` | 1    | int  | 左3气囊 |
| `la4` | 1    | int  | 左4气囊 |
| `ra1` | 1    | int  | 右1气囊 |
| `ra2` | 1    | int  | 右2气囊 |
| `ra3` | 1    | int  | 右3气囊 |
| `ra4` | 1    | int  | 右4气囊 |

不存在手动设置时, 返回空数据

| 字段 | 长度 | 类型 | 描述 |
| ---- | ---- | ---- | ---- |
| `-`  | 0    | void | 空   |

## 修改气囊调节模式(5)

### 请求(长度: 3 + 1 = 4)

**path(长度: 3)**

`5\n\n`

**data (长度: 1)**

| 字段   | 长度 | 类型 | 描述         |
| ------ | ---- | ---- | ------------ |
| `mode` | 1    | int  | 气囊调节模式 |

不同 mode 对应的模式:

- `0x00`: 手动调节模式
- `0x01`: 自动调节模式
- `0x02`: 瑜伽模式

### 响应(长度: 4 = 3 + 1)

**path(长度: 3)**

`5\n\n`

**data (长度: 1)**

| 字段     | 长度 | 类型 | 描述 |
| -------- | ---- | ---- | ---- |
| `status` | 1    | int  | 状态 |

## 心跳包(6)

### 请求(长度: 3)

**path(长度: 3)**

`6\n\n`

**data (长度: 0)**

| 字段 | 长度 | 类型 | 描述 |
| ---- | ---- | ---- | ---- |
| `-`  | 0    | void | 空   |

### 响应(长度: 4 = 3 + 1)

**path(长度: 3)**

`6\n\n`

**data (长度)**

| 字段               | 长度 | 类型 | 描述                                         |
| ------------------ | ---- | ---- | -------------------------------------------- |
| `statusMsg`        | 1    | int  | 状态描述编号                                 |
| `version`          | 1    | int  | 当前版本                                     |
| `mode`             | 1    | int  | 当前模式编号                                 |
| `status`           | 1    | int  | 状态                                         |
| `wind_mode`        | 1    | int  | 新风温控模式 `1:通风 2:暖风 3: 除螨 4: 烘被` |
| `wind_temperature` | 1    | int  | 床垫温度                                     |

**statusMsg 状态描述编号**

| 编号 | 描述字符串             |
| ---- | ---------------------- |
| 0    | `''`                   |
| 1    | `'待机中...'`          |
| 2    | `'正在调节气囊软硬度'` |
| 3    | `'左侧正在瑜伽模式'`   |
| 4    | `'右侧正在瑜伽模式'`   |
| 5    | `'智能适应中'`         |

**mode 当前模式编号**

| 编号 | 模式字符串       |
| ---- | ---------------- |
| 0    | `'个性调节模式'` |
| 1    | `'智能调节模式'` |
| 2    | `'瑜伽模式'`     |


**status 是多个boolean int的组合, 用于表示当前状态, 不同的位表示不同的状态**

| 位  | 描述         |
| --- | ------------ |
| 0   | 是否存在故障 |
| 1   | 是否正在升级 |


```js
const status = 0b00000011
const error = status & 0b00000001
const upgrade = status & 0b00000010
```

```python
error = True
upgrade = True
status = (error << 0) | (upgrade << 1)
```

## 获取床垫固件版本(7)

### 请求(长度: 3)

**path(长度: 3)**

`7\n\n`

**data (长度: 0)**

| 字段 | 长度 | 类型 | 描述 |
| ---- | ---- | ---- | ---- |
| `-`  | 0    | void | 无   |

### 响应(长度: 4 = 3 + 1)

**path(长度: 3)**

`7\n\n`

**data (长度: 1)**

| 字段      | 长度 | 类型 | 描述     |
| --------- | ---- | ---- | -------- |
| `version` | 1    | int  | 固件版本 |


## 气囊补气(8)

### 请求(长度: 3 + 4 = 7)

**path(长度: 3)**

`8\n\n`

**data (长度: 0)**

| 字段      | 长度 | 类型 | 描述 |
| --------- | ---- | ---- | ---- |
| `user_id` | 4    | int  | 无   |

### 响应(长度: 4 = 3 + 1)

**path(长度: 3)**

`8\n\n`

**data (长度: 1)**

| 字段     | 长度 | 类型 | 描述 |
| -------- | ---- | ---- | ---- |
| `status` | 1    | int  | 状态 |

## 获取下一步升级信息(9)

用于继续升级, 需要获取 `版本号，文件名, 偏移量`

### 请求(长度: 3)

**path(长度: 3)**

`9\n\n`

**data (长度: 0)**

| 字段 | 长度 | 类型 | 描述 |
| ---- | ---- | ---- | ---- |
| `-`  | 0    | void | 空   |

### 响应(长度: 3 + 10 + n)

**path(长度: 3)**

`9\n\n`

**data (长度: 10 + n)**

| 字段       | 长度 | 类型 | 描述                                   |
| ---------- | ---- | ---- | -------------------------------------- |
| `version`  | 1    | int  | 升级后的版本号,如果为`0`，则不需要升级 |
| `name_len` | 1    | int  | 文件名长度, 1字节可以                  |
| `name`     | n    | str  | 文件名                                 |
| `offset`   | 4    | int  | 当前升级的偏移量                       |

## 关闭温控(10)

### 请求(长度: 3)

**path(长度: 3)**

`a\n\n`

**data (长度: 0)**

| 字段 | 长度 | 类型 | 描述 |
| ---- | ---- | ---- | ---- |
| `-`  | 0    | void | 空   |

### 响应(长度: 4 = 3 + 1)

**path(长度: 3)**

`a\n\n`

**data (长度: 1)**
| 字段     | 长度 | 类型 | 描述 |
| -------- | ---- | ---- | ---- |
| `status` | 1    | int  | 状态 |

## 切换温控模式(b)

### 请求(长度: 7)

**path(长度: 3)**

`b\n\n`

**data (长度: 4)**

| 字段   | 长度 | 类型 | 描述                                                 |
| ------ | ---- | ---- | ---------------------------------------------------- |
| `mode` | 1    | int  | 温控模式, `0: 通风`, `1: 热风`, `2: 除螨`, `3: 烘被` |
| `dir`  | 1    | int  | 温控方向, `0: 左`, `1: 右`, `2: 全开`                |
| `dur`  | 2    | int  | 持续时间, `单位分钟`                                 |

### 响应(长度: 4 = 3 + 1)

**path(长度: 3)**

`b\n\n`

**data (长度: 1)**
| 字段     | 长度 | 类型 | 描述 |
| -------- | ---- | ---- | ---- |
| `status` | 1    | int  | 状态 |


## 获取体感闹钟列表(c)

### 请求(长度: 3)

**path(长度: 3)**

`c\n\n`

**data (长度: 0)**

| 字段 | 长度 | 类型 | 描述 |
| ---- | ---- | ---- | ---- |
| `-`  | 0    | void | 空   |

### 响应(长度: 3 + 1 + n * 3)

**path(长度: 3)**

`c\n\n`

**data (长度: 1 + n * 3)**

| 字段             | 长度 | 类型 | 描述            |
| ---------------- | ---- | ---- | --------------- |
| `count`          | 1    | int  | 闹钟数量        |
| `alarm1_hours`   | 1    | int  | 闹钟1, 小时     |
| `alarm1_mins`    | 1    | int  | 闹钟1, 分钟     |
| `alarm1_enabled` | 1    | int  | 闹钟1, 是否启用 |
| `alarm2_hours`   | 1    | int  | 闹钟2, 小时     |
| `alarm2_mins`    | 1    | int  | 闹钟2, 分钟     |
| `alarm2_enabled` | 1    | int  | 闹钟2, 是否启用 |

## 添加体感闹钟(d)

### 请求(长度: 7)

**path(长度: 3)**

`d\n\n`

**data (长度: 4)**

| 字段          | 长度 | 类型 | 描述        |
| ------------- | ---- | ---- | ----------- |
| `alarm_hours` | 1    | int  | 闹钟1, 小时 |
| `alarm_mins`  | 1    | int  | 闹钟1, 分钟 |

### 响应(长度: 4 = 3 + 1)

**path(长度: 3)**

`d\n\n`

**data (长度: 1)**

| 字段     | 长度 | 类型 | 描述                                   |
| -------- | ---- | ---- | -------------------------------------- |
| `status` | 1    | int  | 状态, `1:成功添加 2:已存在 3: 超过5个` |


## 删除体感闹钟(e)

### 请求(长度: 3 + 1 + n * 2)

**path(长度: 3)**

`e\n\n`

**data (长度: 1 + n * 2)**

| 字段           | 长度 | 类型 | 描述        |
| -------------- | ---- | ---- | ----------- |
| `count`        | 1    | int  | 闹钟数量    |
| `alarm1_hours` | 1    | int  | 闹钟1, 小时 |
| `alarm2_mins`  | 1    | int  | 闹钟1, 分钟 |
| `alarm2_hours` | 1    | int  | 闹钟2, 小时 |
| `alarm2_mins`  | 1    | int  | 闹钟2, 分钟 |

### 响应(长度: 4 = 3 + 1)

**path(长度: 3)**

`e\n\n`

**data (长度: 1)**

| 字段     | 长度 | 类型 | 描述 |
| -------- | ---- | ---- | ---- |
| `status` | 1    | int  | 状态 |

## 修改体感闹钟(f)

### 请求(长度: 7)

**path(长度: 3)**

`f\n\n`

**data (长度: 4)**

| 字段              | 长度 | 类型 | 描述       |
| ----------------- | ---- | ---- | ---------- |
| `src_alarm_hours` | 1    | int  | 闹钟, 小时 |
| `src_alarm_mins`  | 1    | int  | 闹钟, 分钟 |
| `dst_alarm_hours` | 1    | int  | 闹钟, 小时 |
| `dst_alarm_mins`  | 1    | int  | 闹钟, 分钟 |

### 响应(长度: 4 = 3 + 1)

**path(长度: 3)**

`f\n\n`

**data (长度: 1)**

| 字段     | 长度 | 类型 | 描述                                  |
| -------- | ---- | ---- | ------------------------------------- |
| `status` | 1    | int  | 状态 `1:修改成功 2: 指定的闹钟不存在` |

## 获取睡眠报告数据(g)

> 还未完全确定

### 请求(长度: 3)

**path(长度: 3)**

`g\n\n`

**data (长度: 0)**

| 字段 | 长度 | 类型 | 描述 |
| ---- | ---- | ---- | ---- |
| `-`  | 0    | void | 空   |

### 响应(长度: 3 + 1 + n * 2)

**path(长度: 3)**

`g\n\n`

**data (长度: 1)**

| 字段        | 长度 | 类型 | 描述     |
| ----------- | ---- | ---- | -------- |
| `turn_over` | 1    | int  | 翻身次数 |

## 光子开关(h)

**path(长度: 3)**

`h\n\n`

**data (长度: 1)**

| 字段     | 长度 | 类型 | 描述                      |
| -------- | ---- | ---- | ------------------------- |
| `status` | 1    | int  | 0:关闭光子等,1:开启光子灯 |

### 响应(长度: 3 + 1 = 4)

**path(长度: 3)**

`h\n\n`

**data (长度: 1)**

| 字段     | 长度 | 类型 | 描述                   |
| -------- | ---- | ---- | ---------------------- |
| `result` | 1    | int  | 操作结果 0:失败,1:成功 |
