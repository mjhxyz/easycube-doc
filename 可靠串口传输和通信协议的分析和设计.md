# 可靠串口传输和通信协议的分析和设计

## 传输协议

舒立方的蓝牙传输协议是通过串口（串行接口）将数据传输到另一个设备的协议。为了设计一个可靠的串口传输协议，考虑以下几个方面：


1. **帧格式**: 传输数据之前 需要定义个帧格式, 以下是设计的传输帧

消息头|序号|功能字|数据长度|数据|校验码|时间戳
-|-|-|-|-|-|-
1字节|2字节|1字节|2字节|0-65535字节|1字节|4字节
- 消息头: 固定为 0XAA
- 功能字: 1字节
    - 0: ack
    - 1: nack (没实现)
- 数据长度: 2字节,表示数据部分的长度, 2字节=>16bit=>2^16-1=65535, 大端字节序
- 数据: 长度小于等于65535
- 校验码: 2字节, 对前面的数据部分进行CRC16校验码的计算
- 时间戳: 4字节, 大端字节序 防止重复接收数据

2. **确认应答机制**: 为了保证串口数据的可靠性，需要采用确认应答机制,在收到数据后需要向发送端发送确认应答。如果发送端在一定时间内没有收到确认应答，则认为数据传输失败，需要重新发送数据。
3. **错误检测**: 为了检测数据传输中的错误，使用了 **CRC** 的方式进行检测，如果接收到的结果和计算的结果不一致，则忽略或者发送一个 (nack 帧来让发送方重新发送数据 未实现)。
4. **超时重传**: 为了应对传输数据过程中可能会出现的意外,如通信丢失，数据丢失等，设置了超时重传机制, 。
5. **序号和确认**：在每个数据包中添加序号和确认码，来确保数据包的顺序和完整性。发送方在发送数据包时，会给每个数据包一个序号，接收方收到数据包后会回复一个确认码，表明已经正确接收到了这个数据包。如果发送方在一定时间内没有收到接收方的确认码，会重新发送这个数据包。
6. **防止重复接收报文**: 为了防止重复接收数据，使用时间戳来判断数据包是否已经过期。这里采用了四字节大端字节序传输时间戳。


## 通信协议

上面的传输协议是为了保证数据在不可靠的蓝牙环境中的可靠传输, 在实现了可靠传输后, 还需要设计一个通信协议, 方便应用之间的交互

1. **目标和用途**: 用于手机app和盒子之间进行交互
2. **协议和结构**: 采用 `请求 - 响应模式`, 请求和响应报文都分为`命令`和`数据部分`
3. **数据格式和编码**: 统一使用 `json` 数据格式和 `utf8` 编码, 以确保通信双方能够正确解析和处理数据
4. **错误检测**: 通过双方对于传输内容的协商,确保正确性和完整性
5. **性能和效率**: 暂时还未考虑性能和效率的问题，后续可以考虑压缩传输数据

通信协议如下, 报文示例如下

```
/user/create

{"name": "毛", "age": 100}
```
分为了两个部分

- `命令`: 需要使用命令
- `数据`: 在使用命令的过程中，用到的数据

目前已经使用 js 实现了通信协议的客户端，python 实现了通信协议的客户端和服务端，并且服务端已经仿照flask进行了框架化，能更加容易的进行后续的业务逻辑开发, 例如 添加一个`对时`(同步app上的时间和盒子中的时间)的功能, 服务端可以直接写业务逻辑:

```python
from easycube import app, req

@app.route('/sync/time')
def sync_time():
    data = req.json()
    app_time = data['app_time']
    # TODO 修改系统时间
    return {'code': 0}
```


